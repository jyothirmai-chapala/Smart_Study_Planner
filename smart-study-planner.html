<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Study Planner</title>
  <style>
    :root{--accent:#4f46e5;--muted:#6b7280;--bg:#f8fafc}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:#111}
    header{background:linear-gradient(90deg,#eef2ff,white); padding:18px 22px; display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    .container{max-width:1100px;margin:18px auto;padding:14px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
    .card{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}

    form .row{display:flex;gap:8px;margin-bottom:8px}
    label{font-size:13px;color:var(--muted)}
    input[type=text], input[type=datetime-local], input[type=date], select, textarea, input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    textarea{min-height:78px;resize:vertical}
    button{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px dashed #dbeafe}
    .tasks-list{max-height:60vh;overflow:auto;padding-right:6px}
    .task-item{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:8px}
    .task-main{flex:1}
    .task-title{font-weight:600}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:#eef2ff;color:var(--accent)}
    .controls{display:flex;gap:8px;margin-top:8px}
    .small{font-size:12px;padding:6px 8px}
    .timeline{margin-top:12px}

    /* simple timeline (gantt-like) */
    .timeline-grid{display:grid;grid-template-columns:repeat(14,1fr);gap:6px;align-items:center}
    .timeline-header{display:flex;gap:6px;margin-bottom:8px}
    .timeline-bar{height:28px;border-radius:6px;display:flex;align-items:center;padding-left:8px;color:white;font-size:12px}
    .low{background:#10b981}
    .med{background:#f59e0b}
    .high{background:#ef4444}

    .top-actions{display:flex;gap:8px}
    .muted{color:var(--muted);font-size:13px}

    footer{padding:12px 22px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Smart Study Planner</h1>
      <div class="muted">Create tasks, set reminders & see a visual timeline. Data saved locally.</div>
    </div>
    <div class="top-actions">
      <button id="importBtn" class="ghost small">Import JSON</button>
      <button id="exportBtn" class="small">Export JSON</button>
      <button id="clearAll" class="ghost small">Clear All</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Add / Edit Task</h3>
        <form id="taskForm">
          <input type="hidden" id="taskId">
          <div class="row"><div style="flex:1"><label>Title</label><input id="title" required type="text" placeholder="e.g. Read Chapter 5"/></div></div>
          <div class="row"><div style="flex:1"><label>Description</label><textarea id="description" placeholder="Optional details"></textarea></div></div>
          <div class="row"><div style="flex:1"><label>Start</label><input id="start" type="date"/></div><div style="width:120px"><label>Due</label><input id="due" type="date"/></div></div>
          <div class="row"><div style="flex:1"><label>Priority</label><select id="priority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
            <div style="width:120px"><label>Est. hours</label><input id="hours" type="number" min="0" step="0.5" value="1"/></div></div>
          <div class="row"><div style="flex:1"><label>Reminder (minutes before due)</label><input id="reminder" type="number" min="0" value="30"/></div></div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px">
            <div class="muted">Progress: <span id="progressVal">0%</span></div>
            <div>
              <button type="submit">Save task</button>
              <button id="resetForm" type="button" class="ghost">Reset</button>
            </div>
          </div>
        </form>

        <hr style="margin:12px 0"/>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Tasks</strong>
          <div class="muted">Sort by: <select id="sortBy"><option value="due">Due date</option><option value="priority">Priority</option><option value="created">Created</option></select></div>
        </div>

        <div class="tasks-list card" id="tasksList" style="padding:8px;box-shadow:none;max-height:48vh"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Timeline</h3>
          <div class="muted">Week view (14 days)</div>
        </div>

        <div id="timelineArea" class="timeline"></div>

        <hr/>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted">Notifications: <span id="notifStatus">Not asked</span></div>
          <div>
            <button id="requestNotif" class="small">Enable Notifications</button>
            <button id="checkNow" class="small ghost">Check Reminders</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Made with ♥ · Local storage backup · Export / Import JSON</footer>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // Smart Study Planner
    // Features:
    // - Create / edit / delete tasks
    // - LocalStorage persistence
    // - Simple Gantt-like 14-day timeline
    // - Reminder checks + optional Notification API alert
    // - Export / Import JSON

    const STORAGE_KEY = 'smartStudyPlannerTasks_v1';
    const tasksListEl = document.getElementById('tasksList');
    const taskForm = document.getElementById('taskForm');
    const timelineArea = document.getElementById('timelineArea');
    const notifStatus = document.getElementById('notifStatus');
    const requestNotifBtn = document.getElementById('requestNotif');
    const checkNowBtn = document.getElementById('checkNow');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const clearAllBtn = document.getElementById('clearAll');
    const fileInput = document.getElementById('fileInput');

    let tasks = [];

    // --- Utilities ---
    function uid() { return 't_'+Math.random().toString(36).slice(2,9); }
    function todayPlusDays(n){ const d = new Date(); d.setDate(d.getDate()+n); d.setHours(0,0,0,0); return d; }
    function toISODate(d){ if(!d) return ''; const dt = new Date(d); return dt.toISOString().slice(0,10); }

    // load & save
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); render(); }
    function load(){ try{ tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; }catch(e){tasks=[];} }

    // create / update
    function addOrUpdateTask(data){
      if(!data.id){ data.id = uid(); data.created = new Date().toISOString(); }
      const idx = tasks.findIndex(t=>t.id===data.id);
      if(idx===-1) tasks.push(data); else tasks[idx] = Object.assign(tasks[idx], data);
      save();
    }

    function removeTask(id){ tasks = tasks.filter(t=>t.id!==id); save(); }

    function toggleComplete(id){ const t = tasks.find(x=>x.id===id); if(t){ t.completed = !t.completed; save(); }}

    // render tasks list
    function renderTasks(){
      tasksListEl.innerHTML = '';
      const sortBy = document.getElementById('sortBy').value;
      let items = [...tasks];
      if(sortBy==='due') items.sort((a,b)=> new Date(a.due||0) - new Date(b.due||0));
      if(sortBy==='priority') items.sort((a,b)=> priorityRank(b.priority)-priorityRank(a.priority));
      if(sortBy==='created') items.sort((a,b)=> new Date(b.created) - new Date(a.created));

      if(items.length===0){ tasksListEl.innerHTML = '<div class="muted">No tasks yet — add one!</div>'; return; }

      items.forEach(t=>{
        const el = document.createElement('div'); el.className='task-item';
        const left = document.createElement('div'); left.style.width='8px'; left.style.marginTop='6px'; left.style.height='48px'; left.style.borderRadius='4px';
        left.style.background = t.completed ? '#10b981' : (t.priority==='high'?'#ef4444': (t.priority==='medium'?'#f59e0b':'#60a5fa'));
        const main = document.createElement('div'); main.className='task-main';
        const title = document.createElement('div'); title.className='task-title'; title.textContent = t.title + (t.completed ? ' ✅' : '');
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = (t.start? 'Start: '+t.start + ' · ':'') + (t.due? 'Due: '+t.due + ' · ':'') + '<span class="pill">'+t.priority+'</span>' + ' · Est: '+(t.hours||0)+'h';
        const desc = document.createElement('div'); desc.textContent = t.description || ''; desc.style.marginTop='6px'; desc.style.fontSize='13px'; desc.style.color='#374151';
        const controls = document.createElement('div'); controls.className='controls';

        const editBtn = document.createElement('button'); editBtn.className='small ghost'; editBtn.textContent='Edit'; editBtn.onclick = ()=>fillForm(t.id);
        const delBtn = document.createElement('button'); delBtn.className='small'; delBtn.textContent='Delete'; delBtn.onclick = ()=>{ if(confirm('Delete task?')) removeTask(t.id); };
        const compBtn = document.createElement('button'); compBtn.className='small'; compBtn.textContent = t.completed ? 'Mark undone' : 'Mark done'; compBtn.onclick = ()=>toggleComplete(t.id);

        controls.appendChild(editBtn); controls.appendChild(compBtn); controls.appendChild(delBtn);
        main.appendChild(title); main.appendChild(meta); if(t.description) main.appendChild(desc); main.appendChild(controls);
        el.appendChild(left); el.appendChild(main);
        tasksListEl.appendChild(el);
      });
    }

    function priorityRank(p){ return p==='high'?3: p==='medium'?2:1 }

    // render timeline (14 days from today)
    function renderTimeline(){
      const days = 14; const start = todayPlusDays(0);
      const grid = document.createElement('div'); grid.className='card';
      // header row of dates
      const header = document.createElement('div'); header.className='timeline-header';
      for(let i=0;i<days;i++){ const d = todayPlusDays(i); const s = d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); const h = document.createElement('div'); h.style.minWidth='1fr'; h.style.flex='1'; h.style.textAlign='center'; h.style.fontSize='12px'; h.style.color='#6b7280'; h.textContent=s; header.appendChild(h); }
      grid.appendChild(header);

      // bars per task
      tasks.forEach(t=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.gap='6px'; row.style.marginTop='8px';
        const startDate = t.start ? new Date(t.start) : null; const dueDate = t.due ? new Date(t.due) : null;
        const rowDays = [];
        for(let i=0;i<days;i++){ const d = todayPlusDays(i); rowDays.push(d); }
        // compute position and length
        let pos = 0, len = 1;
        if(startDate && dueDate){
          const ds = Math.floor((startDate - start)/ (1000*60*60*24));
          const de = Math.floor((dueDate - start)/ (1000*60*60*24));
          pos = Math.max(0, ds); len = Math.min(days, Math.max(1, de - ds + 1));
        } else if(dueDate){ const de = Math.floor((dueDate - start)/ (1000*60*60*24)); pos = Math.max(0,de); len=1; }

        // spacer
        for(let i=0;i<pos;i++){ const sp=document.createElement('div'); sp.style.flex='1'; row.appendChild(sp); }
        // bar
        const bar = document.createElement('div'); bar.className = 'timeline-bar ' + (t.priority==='high'?'high': t.priority==='medium'?'med':'low');
        bar.style.flex = ''+len; bar.textContent = t.title + (t.completed ? ' ✓' : '');
        bar.title = (t.start? 'Start: '+t.start + '\n':'') + (t.due? 'Due: '+t.due + '\n':'') + (t.description||'');
        row.appendChild(bar);
        grid.appendChild(row);
      });

      timelineArea.innerHTML=''; timelineArea.appendChild(grid);
    }

    // Fill form for editing
    function fillForm(id){ const t = tasks.find(x=>x.id===id); if(!t) return; document.getElementById('taskId').value = t.id; document.getElementById('title').value = t.title; document.getElementById('description').value = t.description||''; document.getElementById('start').value = t.start||''; document.getElementById('due').value = t.due||''; document.getElementById('priority').value = t.priority||'medium'; document.getElementById('hours').value = t.hours||1; document.getElementById('reminder').value = t.reminder||30; document.getElementById('progressVal').textContent = (t.progress||0)+'%'; window.scrollTo({top:0,behavior:"smooth"}); }

    // Form submit
    taskForm.addEventListener('submit', e=>{
      e.preventDefault(); const id = document.getElementById('taskId').value;
      const payload = {
        id: id||null,
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        start: document.getElementById('start').value || null,
        due: document.getElementById('due').value || null,
        priority: document.getElementById('priority').value,
        hours: parseFloat(document.getElementById('hours').value) || 0,
        reminder: parseInt(document.getElementById('reminder').value) || 0,
        completed: false,
        progress: 0
      };
      if(!payload.title){ alert('Please add a title'); return; }
      addOrUpdateTask(payload);
      taskForm.reset(); document.getElementById('taskId').value=''; document.getElementById('progressVal').textContent='0%';
    });

    document.getElementById('resetForm').addEventListener('click', ()=>{ taskForm.reset(); document.getElementById('taskId').value=''; document.getElementById('progressVal').textContent='0%'; });
    document.getElementById('sortBy').addEventListener('change', render);

    // Notifications
    function updateNotifStatus(){ if(Notification.permission==='granted') notifStatus.textContent='Enabled'; else if(Notification.permission==='denied') notifStatus.textContent='Denied'; else notifStatus.textContent='Not allowed'; }
    requestNotifBtn.addEventListener('click', async ()=>{ if(!('Notification' in window)){ alert('Notifications not supported in this browser'); return; } const p = await Notification.requestPermission(); updateNotifStatus(); });
    updateNotifStatus();

    function checkReminders(now=new Date()){
      const upcoming = tasks.filter(t=>t.due && !t.completed).map(t=>{
        const due = new Date(t.due+'T23:59:59'); // end of day
        const remindBefore = (t.reminder||0) * 60 * 1000;
        const remindAt = new Date(due.getTime() - remindBefore);
        return {task:t, remindAt, due};
      }).filter(x=> x.remindAt <= now && x.due >= now);

      upcoming.forEach(item=>{
        const t = item.task;
        // show notification (only once) -> we mark task._notified
        if(!t._notified){
          t._notified = true; save();
          if(Notification.permission==='granted'){
            new Notification('Reminder: '+t.title, {body: (t.due?('Due: '+t.due):'') + '\n' + (t.description||''), icon: ''});
          } else {
            // fallback alert
            playBeep(); alert('Reminder: '+t.title + '\nDue: '+(t.due||''));
          }
        }
      });
    }

    function playBeep(){ try{ const ctx = new (window.AudioContext || window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; o.frequency.value=880; o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.6); }catch(e){} }

    checkNowBtn.addEventListener('click', ()=>checkReminders(new Date()));

    // background check every minute
    setInterval(()=>{ checkReminders(new Date()); }, 60*1000);

    // export / import
    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='study-planner-backup.json'; a.click(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = e=>{
        try{ const data = JSON.parse(e.target.result); if(Array.isArray(data)){ tasks = data; save(); alert('Imported '+data.length+' tasks'); } else alert('Invalid file'); }catch(err){ alert('Invalid JSON'); }
      }; r.readAsText(f);
    });

    clearAllBtn.addEventListener('click', ()=>{ if(confirm('Clear ALL tasks?')){ tasks=[]; save(); }});

    // initial load & render
    function render(){ renderTasks(); renderTimeline(); updateNotifStatus(); }
    load(); render();

    // seed sample if empty (helpful first-run)
    if(tasks.length===0){ tasks.push({id:uid(), title:'Read Chapter 3 - Algorithms', description:'Focus on examples and exercises', start:toISODate(todayPlusDays(0)), due:toISODate(todayPlusDays(2)), priority:'high', hours:2, reminder:60, completed:false, created:new Date().toISOString()}); save(); }

    // expose for debugging
    window.SSP = {tasks, save, load, addOrUpdateTask, removeTask};
  </script>
</body>
</html>
